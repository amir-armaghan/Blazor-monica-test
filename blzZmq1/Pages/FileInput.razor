@page "/fileInput"
@using blzZmq1.Services
@inject IFileUpload fileUpload
<h3>FileInput</h3>
<InputFile OnChange="HandleFileSelected" />
@if (file != null)
{
    <p>Name: @file.Name</p>
    <p>Size in bytes: @file.Size</p>
    <p>File type: @file.Type</p>
    <p>Last modified date: @file.LastModified.ToShortDateString()</p>
    <p>Number of lines read: @numLines</p>
    <button @onclick="CountLines">Count</button>

    <pre>@fileTextContents</pre>
}
@code {
    int numLines;
    IFileListEntry file;
    string fileTextContents;
    async Task HandleFileSelected(IFileListEntry[] files)
    {
        file = files.FirstOrDefault();

        // the upload process: // if don't use it, the file is on the client memory. That is why we use Async methods.
        using (var reader = new StreamReader(file.Data))
        {
            fileTextContents = await reader.ReadToEndAsync();
        }

        //push msg here...

        if (file != null)
        {
            await fileUpload.UploadAsync(file);
        }
        using (var producer = new PushSocket())
        //using (var producer = new RequestSocket())
        {
            producer.Connect("tcp://localhost:6666");
            producer.SendFrame(fileTextContents);
            //producer.SendFrame("Hello push socket");
            //var message = producer.ReceiveFrameString();
            //string text1 = "push message from blazor";
            // producer.SendFrame(text1);
            //var message = producer.ReceiveFrameString();
            System.Threading.Thread.Sleep(5000);  // it needs some time to send the request so made a delay

        }

    }
    async Task CountLines() // read number of lines
    {
        numLines = 0;
        using (var reader = new System.IO.StreamReader(file.Data))
        {
            while (await reader.ReadLineAsync() != null)
            {
                numLines++;
            }
        }
    }




    /* using (var client = new RequestSocket())
     {
         client.Connect("tcp://localhost:6666");
         for (int i = 0; i < 10; i++)
         {
             //Console.WriteLine("Sending Hello");
             client.SendFrame("Hello");
             var message = client.ReceiveFrameString();
             Console.WriteLine("Received {0}", message);
         }
     }*/


}
